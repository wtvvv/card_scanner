import pyautogui
import keyboard
import time
from threading import Thread
from threading import Event

FILENUMBER_BEGIN = 1430
FILENAME = "UGO00xxxx_common_12MP"

def scanCard(filenumber, exitEvent):
    #scan
    pyautogui.click(1660, 980)
    exit.wait(40)
    if exit.is_set():
        return
    #rotate
    rotated = False
    while not rotated:
        # try:
        #     pyautogui.locateCenterOnScreen('renamebutton.png')
        # except ImageNotFoundException:
        #     pass
        time.sleep(2)
        if(not (pyautogui.locateCenterOnScreen('rotatebutton.png') is None)):
            pyautogui.click(974, 57)
            rotated = True
    exit.wait(10)
    if exit.is_set():
        return

    #rename
    # pyautogui.click(63, 375)
    # pyautogui.rightClick()
    # pyautogui.click(115, 386)
    x, y, width, height = pyautogui.locateOnScreen('newimagebox.png')
    pyautogui.rightClick(x, y)
    pyautogui.move(20, 20)
    pyautogui.click()
    pyautogui.write(FILENAME.replace('xxxx', str(filenumber)))
    time.sleep(1)
    x, y = pyautogui.locateCenterOnScreen('renamebutton.png')
    pyautogui.click(x, y)
    #adjust scroll
    # pyautogui.moveTo(165, 545)
    # pyautogui.scroll(-28)         

if __name__ == "__main__":
    #go to Regula software!!!

    #setup
    exitEvent = Event()
    filenumber = FILENUMBER_BEGIN
    pyautogui.moveTo(165, 545)
    pyautogui.scroll(2000)
    pyautogui.scroll(-28)
    #set 12MP and single-page!!!

    #set up key_detect_enabled
    key_detect_enabled = True

    while not keyboard.is_pressed('esc'):
        if keyboard.is_pressed('s') and key_detect_enabled:
            scanThread = Thread(target = scanCard, args=(filenumber, exitEvent))
            filenumber += 1
            scanThread.start()

        if keyboard.is_pressed('c') and key_detect_enabled:
            exitEvent.set()
            print("interrupt")
            time.sleep(0.5)
            #cancel
            pyautogui.click(1751, 981)
            #delete
            x, y, width, height  = pyautogui.locateOnScreen('newimagebox.png')
            # x += 10
            # y += 10
            pyautogui.click()
            pyautogui.rightClick()
            pyautogui.move(20,40)
            pyautogui.click()
            x, y = pyautogui.locateOnScreen('yesbutton.png')
            pyautogui.click(x, y)
            exit.clear()

        #set up disable key_detect!!!
        # if keyboard.is_pressed(hotkey(Ctrl))
